---
// Static admin page that loads Decap CMS
export const prerender = true;
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Admin</title>
  </head>
  <body>
    <main id="admin-root" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;">
      <div id="login-view" style="text-align:center;max-width:520px;">
        <h1 style="font-size:1.5rem;margin-bottom:0.5rem;">Admin Login</h1>
        <p style="color:#666;margin-bottom:1rem;">Sign in with GitHub to manage content.</p>
        <a id="login-github"
           href="/.netlify/identity/authorize?provider=github"
           style="display:inline-flex;align-items:center;gap:.5rem;background:#24292f;color:white;border-radius:.5rem;padding:.6rem 1rem;text-decoration:none;">
          <svg aria-hidden="true" viewBox="0 0 16 16" width="18" height="18" fill="currentColor">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38
            0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52
            -.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95
            0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27
            c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95
            .29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8Z"/>
          </svg>
          <span>Continue with GitHub</span>
        </a>
        <p style="color:#888;margin-top:1rem;font-size:.9rem;">Email/password login is disabled.</p>
      </div>
    </main>

    <!-- Netlify Identity widget to handle GitHub auth -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
      (function () {
        function loadCMS() {
          // Dynamically load Decap CMS only after authentication
          var s = document.createElement('script');
          s.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
          document.body.appendChild(s);
          // Hide custom login view once CMS takes over
          var loginView = document.getElementById('login-view');
          if (loginView) loginView.style.display = 'none';
        }

        function init() {
          // Wire the GitHub login button to direct provider authorization
          var btn = document.getElementById('login-github');
          if (btn) {
            btn.addEventListener('click', function (e) {
              // Keep default link working on Netlify; no JS required
              // But ensure CMS loads after successful login
              setTimeout(function () { /* no-op */ }, 0);
            });
          }

          if (window.netlifyIdentity) {
            // After GitHub redirects back, Identity initializes with current user
            window.netlifyIdentity.on('init', function (user) {
              if (user) {
                loadCMS();
              }
            });
            window.netlifyIdentity.on('login', function () {
              loadCMS();
            });
            window.netlifyIdentity.on('logout', function () {
              // On logout, show login again
              var loginView = document.getElementById('login-view');
              if (loginView) loginView.style.display = '';
              // Optionally reload to reset CMS state
              window.location.reload();
            });
            // Ensure widget initializes to enable currentUser detection
            window.netlifyIdentity.init();
          }
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      })();
    </script>
  </body>
  
</html>
